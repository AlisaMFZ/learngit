{"version":3,"sources":["index.js"],"names":[],"mappings":"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","file":"index-compiled.js","sourcesContent":["'use strict';\n\nvar resolve = require('./resolve')\n  , util = require('./util')\n  , stableStringify = require('json-stable-stringify')\n  , async = require('../async');\n\nvar beautify;\n\nfunction loadBeautify(){\n  if (beautify === undefined) {\n    var name = 'js-beautify';\n    try { beautify = require(name).js_beautify; }\n    catch(e) { beautify = false; }\n  }\n}\n\nvar validateGenerator = require('../dotjs/validate');\n\n/**\n * Functions below are used inside compiled validations function\n */\n\nvar co = require('co');\nvar ucs2length = util.ucs2length;\nvar equal = require('./equal');\n\n// this error is thrown by async schemas to return validation errors via exception\nvar ValidationError = require('./validation_error');\n\nmodule.exports = compile;\n\n\n/**\n * Compiles schema to validation function\n * @this   Ajv\n * @param  {Object} schema schema object\n * @param  {Object} root object with information about the root schema for this schema\n * @param  {Object} localRefs the hash of local references inside the schema (created by resolve.id), used for inline resolution\n * @param  {String} baseId base ID for IDs in the schema\n * @return {Function} validation function\n */\nfunction compile(schema, root, localRefs, baseId) {\n  /* jshint validthis: true, evil: true */\n  /* eslint no-shadow: 0 */\n  var self = this\n    , opts = this._opts\n    , refVal = [ undefined ]\n    , refs = {}\n    , patterns = []\n    , patternsHash = {}\n    , defaults = []\n    , defaultsHash = {}\n    , customRules = []\n    , keepSourceCode = opts.sourceCode !== false;\n\n  root = root || { schema: schema, refVal: refVal, refs: refs };\n\n  var c = checkCompiling.call(this, schema, root, baseId);\n  var compilation = this._compilations[c.index];\n  if (c.compiling) return (compilation.callValidate = callValidate);\n\n  var formats = this._formats;\n  var RULES = this.RULES;\n\n  try {\n    var v = localCompile(schema, root, localRefs, baseId);\n    compilation.validate = v;\n    var cv = compilation.callValidate;\n    if (cv) {\n      cv.schema = v.schema;\n      cv.errors = null;\n      cv.refs = v.refs;\n      cv.refVal = v.refVal;\n      cv.root = v.root;\n      cv.$async = v.$async;\n      if (keepSourceCode) cv.sourceCode = v.sourceCode;\n    }\n    return v;\n  } finally {\n    endCompiling.call(this, schema, root, baseId);\n  }\n\n  function callValidate() {\n    var validate = compilation.validate;\n    var result = validate.apply(null, arguments);\n    callValidate.errors = validate.errors;\n    return result;\n  }\n\n  function localCompile(_schema, _root, localRefs, baseId) {\n    var isRoot = !_root || (_root && _root.schema == _schema);\n    if (_root.schema != root.schema)\n      return compile.call(self, _schema, _root, localRefs, baseId);\n\n    var $async = _schema.$async === true;\n    if ($async && !opts.transpile) async.setup(opts);\n\n    var sourceCode = validateGenerator({\n      isTop: true,\n      schema: _schema,\n      isRoot: isRoot,\n      baseId: baseId,\n      root: _root,\n      schemaPath: '',\n      errSchemaPath: '#',\n      errorPath: '\"\"',\n      RULES: RULES,\n      validate: validateGenerator,\n      util: util,\n      resolve: resolve,\n      resolveRef: resolveRef,\n      usePattern: usePattern,\n      useDefault: useDefault,\n      useCustomRule: useCustomRule,\n      opts: opts,\n      formats: formats,\n      self: self\n    });\n\n    sourceCode = vars(refVal, refValCode) + vars(patterns, patternCode)\n                   + vars(defaults, defaultCode) + vars(customRules, customRuleCode)\n                   + sourceCode;\n\n    if (opts.beautify) {\n      loadBeautify();\n      /* istanbul ignore else */\n      if (beautify) sourceCode = beautify(sourceCode, opts.beautify);\n      else console.error('\"npm install js-beautify\" to use beautify option');\n    }\n    // console.log('\\n\\n\\n *** \\n', sourceCode);\n    var validate, validateCode\n      , transpile = opts._transpileFunc;\n    try {\n      validateCode = $async && transpile\n                      ? transpile(sourceCode)\n                      : sourceCode;\n\n      var makeValidate = new Function(\n        'self',\n        'RULES',\n        'formats',\n        'root',\n        'refVal',\n        'defaults',\n        'customRules',\n        'co',\n        'equal',\n        'ucs2length',\n        'ValidationError',\n        validateCode\n      );\n\n      validate = makeValidate(\n        self,\n        RULES,\n        formats,\n        root,\n        refVal,\n        defaults,\n        customRules,\n        co,\n        equal,\n        ucs2length,\n        ValidationError\n      );\n\n      refVal[0] = validate;\n    } catch(e) {\n      console.error('Error compiling schema, function code:', validateCode);\n      throw e;\n    }\n\n    validate.schema = _schema;\n    validate.errors = null;\n    validate.refs = refs;\n    validate.refVal = refVal;\n    validate.root = isRoot ? validate : _root;\n    if ($async) validate.$async = true;\n    if (keepSourceCode) validate.sourceCode = sourceCode;\n    if (opts.sourceCode === true) {\n      validate.source = {\n        patterns: patterns,\n        defaults: defaults\n      };\n    }\n\n    return validate;\n  }\n\n  function resolveRef(baseId, ref, isRoot) {\n    ref = resolve.url(baseId, ref);\n    var refIndex = refs[ref];\n    var _refVal, refCode;\n    if (refIndex !== undefined) {\n      _refVal = refVal[refIndex];\n      refCode = 'refVal[' + refIndex + ']';\n      return resolvedRef(_refVal, refCode);\n    }\n    if (!isRoot && root.refs) {\n      var rootRefId = root.refs[ref];\n      if (rootRefId !== undefined) {\n        _refVal = root.refVal[rootRefId];\n        refCode = addLocalRef(ref, _refVal);\n        return resolvedRef(_refVal, refCode);\n      }\n    }\n\n    refCode = addLocalRef(ref);\n    var v = resolve.call(self, localCompile, root, ref);\n    if (!v) {\n      var localSchema = localRefs && localRefs[ref];\n      if (localSchema) {\n        v = resolve.inlineRef(localSchema, opts.inlineRefs)\n            ? localSchema\n            : compile.call(self, localSchema, root, localRefs, baseId);\n      }\n    }\n\n    if (v) {\n      replaceLocalRef(ref, v);\n      return resolvedRef(v, refCode);\n    }\n  }\n\n  function addLocalRef(ref, v) {\n    var refId = refVal.length;\n    refVal[refId] = v;\n    refs[ref] = refId;\n    return 'refVal' + refId;\n  }\n\n  function replaceLocalRef(ref, v) {\n    var refId = refs[ref];\n    refVal[refId] = v;\n  }\n\n  function resolvedRef(refVal, code) {\n    return typeof refVal == 'object'\n            ? { code: code, schema: refVal, inline: true }\n            : { code: code, $async: refVal && refVal.$async };\n  }\n\n  function usePattern(regexStr) {\n    var index = patternsHash[regexStr];\n    if (index === undefined) {\n      index = patternsHash[regexStr] = patterns.length;\n      patterns[index] = regexStr;\n    }\n    return 'pattern' + index;\n  }\n\n  function useDefault(value) {\n    switch (typeof value) {\n      case 'boolean':\n      case 'number':\n        return '' + value;\n      case 'string':\n        return util.toQuotedString(value);\n      case 'object':\n        if (value === null) return 'null';\n        var valueStr = stableStringify(value);\n        var index = defaultsHash[valueStr];\n        if (index === undefined) {\n          index = defaultsHash[valueStr] = defaults.length;\n          defaults[index] = value;\n        }\n        return 'default' + index;\n    }\n  }\n\n  function useCustomRule(rule, schema, parentSchema, it) {\n    var validateSchema = rule.definition.validateSchema;\n    if (validateSchema && self._opts.validateSchema !== false) {\n      var valid = validateSchema(schema);\n      if (!valid) {\n        var message = 'keyword schema is invalid: ' + self.errorsText(validateSchema.errors);\n        if (self._opts.validateSchema == 'log') console.error(message);\n        else throw new Error(message);\n      }\n    }\n\n    var compile = rule.definition.compile\n      , inline = rule.definition.inline\n      , macro = rule.definition.macro;\n\n    var validate;\n    if (compile) {\n      validate = compile.call(self, schema, parentSchema, it);\n    } else if (macro) {\n      validate = macro.call(self, schema, parentSchema, it);\n      if (opts.validateSchema !== false) self.validateSchema(validate, true);\n    } else if (inline) {\n      validate = inline.call(self, it, rule.keyword, schema, parentSchema);\n    } else {\n      validate = rule.definition.validate;\n    }\n\n    var index = customRules.length;\n    customRules[index] = validate;\n\n    return {\n      code: 'customRule' + index,\n      validate: validate\n    };\n  }\n}\n\n\n/**\n * Checks if the schema is currently compiled\n * @this   Ajv\n * @param  {Object} schema schema to compile\n * @param  {Object} root root object\n * @param  {String} baseId base schema ID\n * @return {Object} object with properties \"index\" (compilation index) and \"compiling\" (boolean)\n */\nfunction checkCompiling(schema, root, baseId) {\n  /* jshint validthis: true */\n  var index = compIndex.call(this, schema, root, baseId);\n  if (index >= 0) return { index: index, compiling: true };\n  index = this._compilations.length;\n  this._compilations[index] = {\n    schema: schema,\n    root: root,\n    baseId: baseId\n  };\n  return { index: index, compiling: false };\n}\n\n\n/**\n * Removes the schema from the currently compiled list\n * @this   Ajv\n * @param  {Object} schema schema to compile\n * @param  {Object} root root object\n * @param  {String} baseId base schema ID\n */\nfunction endCompiling(schema, root, baseId) {\n  /* jshint validthis: true */\n  var i = compIndex.call(this, schema, root, baseId);\n  if (i >= 0) this._compilations.splice(i, 1);\n}\n\n\n/**\n * Index of schema compilation in the currently compiled list\n * @this   Ajv\n * @param  {Object} schema schema to compile\n * @param  {Object} root root object\n * @param  {String} baseId base schema ID\n * @return {Integer} compilation index\n */\nfunction compIndex(schema, root, baseId) {\n  /* jshint validthis: true */\n  for (var i=0; i<this._compilations.length; i++) {\n    var c = this._compilations[i];\n    if (c.schema == schema && c.root == root && c.baseId == baseId) return i;\n  }\n  return -1;\n}\n\n\nfunction patternCode(i, patterns) {\n  return 'var pattern' + i + ' = new RegExp(' + util.toQuotedString(patterns[i]) + ');';\n}\n\n\nfunction defaultCode(i) {\n  return 'var default' + i + ' = defaults[' + i + '];';\n}\n\n\nfunction refValCode(i, refVal) {\n  return refVal[i] ? 'var refVal' + i + ' = refVal[' + i + '];' : '';\n}\n\n\nfunction customRuleCode(i) {\n  return 'var customRule' + i + ' = customRules[' + i + '];';\n}\n\n\nfunction vars(arr, statement) {\n  if (!arr.length) return '';\n  var code = '';\n  for (var i=0; i<arr.length; i++)\n    code += statement(i, arr);\n  return code;\n}\n"]}