{"version":3,"sources":["6-restructBlock.js"],"names":[],"mappings":";;;;;;;;;;;;AAAA,IAAI,kBAAkB,QAAQ,sBAAR,EAAgC,QAAtD;AACA,IAAI,iBAAiB,QAAQ,sBAAR,EAAgC,OAArD;AACA,IAAI,iBAAiB,QAAQ,qBAAR,EAA+B,UAApD;AACA,IAAI,YAAY,QAAQ,0BAAR,CAAhB;AACA,IAAI,kBAAkB;AAClB,WAAO,CADW,CACT;AADS,CAAtB;;AAIA,IAAI,iBAAiB;AACjB;AACA,eAAW,oDAFM;AAGjB;AACA,kBAAc;AAJG,CAArB;;AAOA,IAAI,oBAAoB,CACpB,MADoB,EACZ,WADY,EACC,SADD,EACY,MADZ,EACoB,MADpB,EAC4B,MAD5B,EACoC,MADpC,EAEpB,UAFoB,EAER,UAFQ,EAEI,UAFJ,EAEgB,UAFhB,EAGpB,WAHoB,EAGP,WAHO,EAGM,WAHN,EAGmB,WAHnB,EAIpB,SAJoB,EAIT,UAJS,EAIG,aAJH,EAIkB,SAJlB,EAI6B,eAJ7B,EAI8C,YAJ9C,EAKpB,YALoB,EAKN,YALM,CAAxB;;AAQA,IAAI,iBAAiB;AACjB,oBAAgB,CAAC,QAAD,CADC;AAEjB,oBAAgB,CAAC,QAAD,CAFC;AAGjB,oBAAgB,CAAC,QAAD,CAHC;AAIjB,kBAAc,CAAC,QAAD,CAJG;AAKjB,oBAAgB,CAAC,QAAD,CALC;AAMjB,qBAAiB,CAAC,QAAD,CANA;AAOjB,mBAAe,CAAC,QAAD,CAPE;AAQjB,wBAAoB,CAAC,YAAD,EAAe,cAAf,EAA+B,QAA/B,CARH;AASjB,0BAAsB,CAAC,cAAD,EAAiB,cAAjB,EAAiC,QAAjC,CATL;AAUjB,2BAAuB,CAAC,eAAD,EAAkB,cAAlB,EAAkC,QAAlC,CAVN;AAWjB,yBAAqB,CAAC,aAAD,EAAgB,cAAhB,EAAgC,QAAhC,CAXJ;AAYjB,wBAAoB,CAAC,YAAD,EAAe,cAAf,EAA+B,QAA/B,CAZH;AAajB,0BAAsB,CAAC,cAAD,EAAiB,cAAjB,EAAiC,QAAjC,CAbL;AAcjB,2BAAuB,CAAC,eAAD,EAAkB,cAAlB,EAAkC,QAAlC,CAdN;AAejB,yBAAqB,CAAC,aAAD,EAAgB,cAAhB,EAAgC,QAAhC,CAfJ;AAgBjB,wBAAoB,CAAC,YAAD,EAAe,cAAf,EAA+B,QAA/B,CAhBH;AAiBjB,0BAAsB,CAAC,cAAD,EAAiB,cAAjB,EAAiC,QAAjC,CAjBL;AAkBjB,2BAAuB,CAAC,eAAD,EAAkB,cAAlB,EAAkC,QAAlC,CAlBN;AAmBjB,yBAAqB,CAAC,aAAD,EAAgB,cAAhB,EAAgC,QAAhC,CAnBJ;AAoBjB,kBAAc,CAAC,QAAD,CApBG;AAqBjB,oBAAgB,CAAC,QAAD,CArBC;AAsBjB,qBAAiB,CAAC,QAAD,CAtBA;AAuBjB,mBAAe,CAAC,QAAD,CAvBE;AAwBjB,mBAAe,CAAC,SAAD,CAxBE;AAyBjB,qBAAiB,CAAC,SAAD,CAzBA;AA0BjB,sBAAkB,CAAC,SAAD,CA1BD;AA2BjB,oBAAgB,CAAC,SAAD,CA3BC;AA4BjB,kBAAc,CAAC,MAAD,CA5BG;AA6BjB,oBAAgB,CAAC,MAAD,CA7BC;AA8BjB,mBAAe,CAAC,MAAD,CA9BE;AA+BjB,iBAAa,CAAC,MAAD,CA/BI;AAgCjB,mBAAe,CAAC,MAAD,CAhCE;AAiCjB,uBAAmB,CAAC,YAAD,CAjCF;AAkCjB,2BAAuB,CAAC,YAAD,CAlCN;AAmCjB,wBAAoB,CAAC,YAAD;AAnCH,CAArB;;AAsCA,SAAS,sBAAT,CAAgC,YAAhC,EAA8C,WAA9C,EAA2D,YAA3D,EAAyE;AACrE,QAAI,WAAW,gBAAgB,YAAhB,EAA8B,IAA7C;;AAEA,QAAI,aAAa,YAAb,IACA,aAAa,QAAb,IAAyB,YAAY,KAAZ,CAAkB,QAAlB,CAA2B,KAA3B,GAAmC,IAAnC,KAA4C,QADzE,EACoF;AAChF,eAAO,eAAe,GAAf,GAAqB,UAAU,YAAY,KAAtB,CAA5B;AACH;;AAED,QAAI,gBAAgB,YAAY,EAAhC;AACA,QAAI,cAAc,aAAa,aAAb,CAAlB;;AAEA,QAAI,CAAC,WAAL,EAAkB;AACd,YAAI,WAAW,EAAf;AACA,YAAI,SAAS,EAAb;AACA,YAAI,UAAU,EAAd;;AAEA,oBAAY,KAAZ,CAAkB,QAAlB,CAA2B,IAA3B,CAAgC,SAAS,IAAT,CAAc,IAAd,EAAoB;AAChD,oBAAQ,KAAK,IAAb;AACI,qBAAK,UAAL;AACA,qBAAK,OAAL;AACA,qBAAK,QAAL;AACI,yBAAK,QAAL,CAAc,IAAd,CAAmB,IAAnB;AACA;;AAEJ,qBAAK,YAAL;AACI,wBAAI,OAAO,KAAK,IAAhB;;AAEA,wBAAI,CAAC,QAAL,EAAe;AACX,mCAAW,eAAe,IAAf,EAAqB,MAAhC;AACH;;AAED,wBAAI,SAAS,IAAT,CAAc,IAAd,CAAJ,EAAyB;AACrB,iCAAS,OAAO,SAAhB;AACH;;AAED,wBAAI,aAAa,QAAjB,EAA2B;AACvB,4BAAI,kBAAkB,OAAlB,CAA0B,IAA1B,MAAoC,CAAC,CAAzC,EAA4C;AACxC,oCAAQ,IAAR,IAAgB,IAAhB;AACH;AACJ,qBAJD,MAIO,IAAI,eAAe,cAAf,CAA8B,QAA9B,CAAJ,EAA6C;AAChD,4BAAI,eAAe,QAAf,EAAyB,IAAzB,CAA8B,IAA9B,CAAJ,EAAyC;AACrC,oCAAQ,IAAR,IAAgB,IAAhB;AACH;AACJ;;AAED;;AAEJ,qBAAK,UAAL;AACI,wBAAI,OAAO,KAAK,IAAhB;;AAEA,wBAAI,CAAC,QAAL,EAAe;AACX,mCAAW,eAAe,IAAf,EAAqB,MAAhC;AACH;;AAED,wBAAI,SAAS,MAAb,EAAqB;AACjB;AACA;AACA;AACA;AACA,4BAAI,KAAK,SAAL,CAAe,IAAf,GAAsB,CAA1B,EAA6B;AACzB,mCAAO,eAAP;AACH;AACJ;;AAED,4BAAQ,OAAO,IAAf,IAAuB,IAAvB;;AAEA;AACA,yBAAK,SAAL,CAAe,IAAf,CAAoB,IAApB;;AAEA;;AAEJ,qBAAK,WAAL;AACI,wBAAI,OAAO,KAAK,IAAhB;;AAEA,4BAAQ,IAAR;AACI;AACA,6BAAK,KAAL;;AAEA;AACA;AACA,6BAAK,IAAL;AACA,6BAAK,IAAL;AACA,6BAAK,MAAL;AACA,6BAAK,MAAL;AACA,6BAAK,IAAL;AAAW;AACP,oCAAQ,IAAR,IAAgB,IAAhB;AACA;AAZR;AAcA;AAvER;AAyEH,SA1ED;;AA4EA,sBAAc,MAAM,oBAAY,OAAZ,EAAqB,IAArB,EAAN,GAAoC,GAApC,GAA0C,MAA1C,GAAmD,QAAjE;;AAEA,qBAAa,aAAb,IAA8B,WAA9B;AACH;;AAED,WAAO,eAAe,WAAtB;AACH;;AAED,SAAS,QAAT,CAAkB,KAAlB,EAAyB,WAAzB,EAAsC,YAAtC,EAAoD;AAChD,QAAI,WAAW,gBAAgB,YAAY,QAAZ,CAAqB,IAArC,CAAf;;AAEA,QAAI,eAAe,cAAf,CAA8B,SAAS,IAAvC,CAAJ,EAAkD;AAC9C,YAAI,QAAQ,eAAe,SAAS,IAAxB,CAAZ;;AAEA,aAAK,IAAI,IAAI,CAAb,EAAgB,IAAI,MAAM,MAA1B,EAAkC,GAAlC,EAAuC;AACnC,gBAAI,OAAO,uBAAuB,SAAS,MAAT,GAAkB,MAAM,CAAN,CAAzC,EAAmD,WAAnD,EAAgE,YAAhE,CAAX;AACA,gBAAI,OAAO,MAAM,IAAN,CAAX;;AAEA,gBAAI,SAAS,CAAC,YAAY,KAAZ,CAAkB,SAAnB,IAAgC,KAAK,IAAL,CAAU,IAAV,CAAe,KAAf,CAAqB,SAA9D,CAAJ,EAA8E;AAC1E,uBAAO,IAAP;AACH;AACJ;AACJ;AACJ;;AAED,SAAS,cAAT,CAAwB,OAAxB,EAAiC,IAAjC,EAAuC,IAAvC,EAA6C,KAA7C,EAAoD,YAApD,EAAkE;AAC9D,QAAI,eAAe,QAAQ,KAAR,CAAc,YAAjC;;AAEA,iBAAa,SAAb,CAAuB,UAAS,WAAT,EAAsB,eAAtB,EAAuC;AAC1D,YAAI,WAAW,YAAY,QAAZ,CAAqB,IAApC;AACA,YAAI,cAAc,uBAAuB,QAAvB,EAAiC,WAAjC,EAA8C,YAA9C,CAAlB;AACA,YAAI,OAAO,MAAM,WAAN,CAAX;;AAEA,YAAI,QAAQ,CAAC,gBAAgB,cAAhB,CAA+B,QAA/B,CAAb,EAAuD;AACnD,gBAAI,YAAY,KAAZ,CAAkB,SAAlB,IAA+B,CAAC,KAAK,IAAL,CAAU,IAAV,CAAe,KAAf,CAAqB,SAAzD,EAAoE;AAChE,sBAAM,WAAN,IAAqB;AACjB,2BAAO,YADU;AAEjB,0BAAM;AAFW,iBAArB;;AAKA,qBAAK,KAAL,CAAW,MAAX,CAAkB,KAAK,IAAvB;AACA,4BAAY,IAAZ,GAAmB;AACf,6BAAS,YAAY,IADN;AAEf,4BAAQ,KAAK,IAAL,CAAU,IAAV,CAAe;AAFR,iBAAnB;AAIH,aAXD,MAWO;AACH,6BAAa,MAAb,CAAoB,eAApB;AACA,qBAAK,IAAL,CAAU,IAAV,CAAe,IAAf,GAAsB;AAClB,6BAAS,KAAK,IAAL,CAAU,IAAV,CAAe,IADN;AAElB,4BAAQ,YAAY;AAFF,iBAAtB;AAIH;AACJ,SAnBD,MAmBO;AACH,gBAAI,OAAO,SAAS,KAAT,EAAgB,WAAhB,EAA6B,YAA7B,CAAX;;AAEA,gBAAI,IAAJ,EAAU;AACN,6BAAa,MAAb,CAAoB,eAApB;AACA,qBAAK,IAAL,CAAU,IAAV,CAAe,IAAf,GAAsB;AAClB,6BAAS,KAAK,IAAL,CAAU,IAAV,CAAe,IADN;AAElB,4BAAQ,YAAY;AAFF,iBAAtB;AAIH,aAND,MAMO;AACH,4BAAY,WAAZ,GAA0B,WAA1B;;AAEA,sBAAM,WAAN,IAAqB;AACjB,2BAAO,YADU;AAEjB,0BAAM;AAFW,iBAArB;AAIH;AACJ;AACJ,KA1CD;;AA4CA,QAAI,aAAa,OAAb,EAAJ,EAA4B;AACxB,aAAK,MAAL,CAAY,IAAZ;AACH;AACJ;;AAED,OAAO,OAAP,GAAiB,SAAS,aAAT,CAAuB,GAAvB,EAA4B;AACzC,QAAI,gBAAgB,EAApB;AACA,QAAI,eAAe,sBAAc,IAAd,CAAnB;;AAEA,mBAAe,GAAf,EAAoB,UAAS,IAAT,EAAe,IAAf,EAAqB,IAArB,EAA2B;AAC3C,YAAI,KAAK,IAAL,KAAc,SAAlB,EAA6B;AACzB;AACH;;AAED,YAAI,aAAa,KAAK,UAAtB;AACA,YAAI,YAAY,CAAC,KAAK,eAAL,IAAwB,EAAzB,IAA+B,GAA/B,GAAqC,KAAK,QAAL,CAAc,SAAd,CAAwB,KAAxB,GAAgC,EAArF;AACA,YAAI,UAAJ;AACA,YAAI,KAAJ;;AAEA,YAAI,CAAC,cAAc,cAAd,CAA6B,WAAW,EAAxC,CAAL,EAAkD;AAC9C,yBAAa,EAAb;AACA,0BAAc,WAAW,EAAzB,IAA+B,UAA/B;AACH,SAHD,MAGO;AACH,yBAAa,cAAc,WAAW,EAAzB,CAAb;AACH;;AAED,YAAI,WAAW,cAAX,CAA0B,SAA1B,CAAJ,EAA0C;AACtC,oBAAQ,WAAW,SAAX,CAAR;AACH,SAFD,MAEO;AACH,oBAAQ,EAAR;AACA,uBAAW,SAAX,IAAwB,KAAxB;AACH;;AAED,uBAAe,IAAf,CAAoB,IAApB,EAA0B,IAA1B,EAAgC,IAAhC,EAAsC,IAAtC,EAA4C,KAA5C,EAAmD,YAAnD;AACH,KAzBD;AA0BH,CA9BD","file":"6-restructBlock-compiled.js","sourcesContent":["var resolveProperty = require('../../utils/names.js').property;\nvar resolveKeyword = require('../../utils/names.js').keyword;\nvar walkRulesRight = require('../../utils/walk.js').rulesRight;\nvar translate = require('../../utils/translate.js');\nvar dontRestructure = {\n    'src': 1 // https://github.com/afelix/csso/issues/50\n};\n\nvar DONT_MIX_VALUE = {\n    // https://developer.mozilla.org/en-US/docs/Web/CSS/display#Browser_compatibility\n    'display': /table|ruby|flex|-(flex)?box$|grid|contents|run-in/i,\n    // https://developer.mozilla.org/en/docs/Web/CSS/text-align\n    'text-align': /^(start|end|match-parent|justify-all)$/i\n};\n\nvar CURSOR_SAFE_VALUE = [\n    'auto', 'crosshair', 'default', 'move', 'text', 'wait', 'help',\n    'n-resize', 'e-resize', 's-resize', 'w-resize',\n    'ne-resize', 'nw-resize', 'se-resize', 'sw-resize',\n    'pointer', 'progress', 'not-allowed', 'no-drop', 'vertical-text', 'all-scroll',\n    'col-resize', 'row-resize'\n];\n\nvar NEEDLESS_TABLE = {\n    'border-width': ['border'],\n    'border-style': ['border'],\n    'border-color': ['border'],\n    'border-top': ['border'],\n    'border-right': ['border'],\n    'border-bottom': ['border'],\n    'border-left': ['border'],\n    'border-top-width': ['border-top', 'border-width', 'border'],\n    'border-right-width': ['border-right', 'border-width', 'border'],\n    'border-bottom-width': ['border-bottom', 'border-width', 'border'],\n    'border-left-width': ['border-left', 'border-width', 'border'],\n    'border-top-style': ['border-top', 'border-style', 'border'],\n    'border-right-style': ['border-right', 'border-style', 'border'],\n    'border-bottom-style': ['border-bottom', 'border-style', 'border'],\n    'border-left-style': ['border-left', 'border-style', 'border'],\n    'border-top-color': ['border-top', 'border-color', 'border'],\n    'border-right-color': ['border-right', 'border-color', 'border'],\n    'border-bottom-color': ['border-bottom', 'border-color', 'border'],\n    'border-left-color': ['border-left', 'border-color', 'border'],\n    'margin-top': ['margin'],\n    'margin-right': ['margin'],\n    'margin-bottom': ['margin'],\n    'margin-left': ['margin'],\n    'padding-top': ['padding'],\n    'padding-right': ['padding'],\n    'padding-bottom': ['padding'],\n    'padding-left': ['padding'],\n    'font-style': ['font'],\n    'font-variant': ['font'],\n    'font-weight': ['font'],\n    'font-size': ['font'],\n    'font-family': ['font'],\n    'list-style-type': ['list-style'],\n    'list-style-position': ['list-style'],\n    'list-style-image': ['list-style']\n};\n\nfunction getPropertyFingerprint(propertyName, declaration, fingerprints) {\n    var realName = resolveProperty(propertyName).name;\n\n    if (realName === 'background' ||\n       (realName === 'filter' && declaration.value.sequence.first().type === 'Progid')) {\n        return propertyName + ':' + translate(declaration.value);\n    }\n\n    var declarationId = declaration.id;\n    var fingerprint = fingerprints[declarationId];\n\n    if (!fingerprint) {\n        var vendorId = '';\n        var iehack = '';\n        var special = {};\n\n        declaration.value.sequence.each(function walk(node) {\n            switch (node.type) {\n                case 'Argument':\n                case 'Value':\n                case 'Braces':\n                    node.sequence.each(walk);\n                    break;\n\n                case 'Identifier':\n                    var name = node.name;\n\n                    if (!vendorId) {\n                        vendorId = resolveKeyword(name).vendor;\n                    }\n\n                    if (/\\\\[09]/.test(name)) {\n                        iehack = RegExp.lastMatch;\n                    }\n\n                    if (realName === 'cursor') {\n                        if (CURSOR_SAFE_VALUE.indexOf(name) === -1) {\n                            special[name] = true;\n                        }\n                    } else if (DONT_MIX_VALUE.hasOwnProperty(realName)) {\n                        if (DONT_MIX_VALUE[realName].test(name)) {\n                            special[name] = true;\n                        }\n                    }\n\n                    break;\n\n                case 'Function':\n                    var name = node.name;\n\n                    if (!vendorId) {\n                        vendorId = resolveKeyword(name).vendor;\n                    }\n\n                    if (name === 'rect') {\n                        // there are 2 forms of rect:\n                        //   rect(<top>, <right>, <bottom>, <left>) - standart\n                        //   rect(<top> <right> <bottom> <left>) – backwards compatible syntax\n                        // only the same form values can be merged\n                        if (node.arguments.size < 4) {\n                            name = 'rect-backward';\n                        }\n                    }\n\n                    special[name + '()'] = true;\n\n                    // check nested tokens too\n                    node.arguments.each(walk);\n\n                    break;\n\n                case 'Dimension':\n                    var unit = node.unit;\n\n                    switch (unit) {\n                        // is not supported until IE11\n                        case 'rem':\n\n                        // v* units is too buggy across browsers and better\n                        // don't merge values with those units\n                        case 'vw':\n                        case 'vh':\n                        case 'vmin':\n                        case 'vmax':\n                        case 'vm': // IE9 supporting \"vm\" instead of \"vmin\".\n                            special[unit] = true;\n                            break;\n                    }\n                    break;\n            }\n        });\n\n        fingerprint = '|' + Object.keys(special).sort() + '|' + iehack + vendorId;\n\n        fingerprints[declarationId] = fingerprint;\n    }\n\n    return propertyName + fingerprint;\n}\n\nfunction needless(props, declaration, fingerprints) {\n    var property = resolveProperty(declaration.property.name);\n\n    if (NEEDLESS_TABLE.hasOwnProperty(property.name)) {\n        var table = NEEDLESS_TABLE[property.name];\n\n        for (var i = 0; i < table.length; i++) {\n            var ppre = getPropertyFingerprint(property.prefix + table[i], declaration, fingerprints);\n            var prev = props[ppre];\n\n            if (prev && (!declaration.value.important || prev.item.data.value.important)) {\n                return prev;\n            }\n        }\n    }\n}\n\nfunction processRuleset(ruleset, item, list, props, fingerprints) {\n    var declarations = ruleset.block.declarations;\n\n    declarations.eachRight(function(declaration, declarationItem) {\n        var property = declaration.property.name;\n        var fingerprint = getPropertyFingerprint(property, declaration, fingerprints);\n        var prev = props[fingerprint];\n\n        if (prev && !dontRestructure.hasOwnProperty(property)) {\n            if (declaration.value.important && !prev.item.data.value.important) {\n                props[fingerprint] = {\n                    block: declarations,\n                    item: declarationItem\n                };\n\n                prev.block.remove(prev.item);\n                declaration.info = {\n                    primary: declaration.info,\n                    merged: prev.item.data.info\n                };\n            } else {\n                declarations.remove(declarationItem);\n                prev.item.data.info = {\n                    primary: prev.item.data.info,\n                    merged: declaration.info\n                };\n            }\n        } else {\n            var prev = needless(props, declaration, fingerprints);\n\n            if (prev) {\n                declarations.remove(declarationItem);\n                prev.item.data.info = {\n                    primary: prev.item.data.info,\n                    merged: declaration.info\n                };\n            } else {\n                declaration.fingerprint = fingerprint;\n\n                props[fingerprint] = {\n                    block: declarations,\n                    item: declarationItem\n                };\n            }\n        }\n    });\n\n    if (declarations.isEmpty()) {\n        list.remove(item);\n    }\n};\n\nmodule.exports = function restructBlock(ast) {\n    var stylesheetMap = {};\n    var fingerprints = Object.create(null);\n\n    walkRulesRight(ast, function(node, item, list) {\n        if (node.type !== 'Ruleset') {\n            return;\n        }\n\n        var stylesheet = this.stylesheet;\n        var rulesetId = (node.pseudoSignature || '') + '|' + node.selector.selectors.first().id;\n        var rulesetMap;\n        var props;\n\n        if (!stylesheetMap.hasOwnProperty(stylesheet.id)) {\n            rulesetMap = {};\n            stylesheetMap[stylesheet.id] = rulesetMap;\n        } else {\n            rulesetMap = stylesheetMap[stylesheet.id];\n        }\n\n        if (rulesetMap.hasOwnProperty(rulesetId)) {\n            props = rulesetMap[rulesetId];\n        } else {\n            props = {};\n            rulesetMap[rulesetId] = props;\n        }\n\n        processRuleset.call(this, node, item, list, props, fingerprints);\n    });\n};\n"]}